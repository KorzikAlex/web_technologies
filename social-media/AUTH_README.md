# Авторизация в социальной сети

## Реализованная функциональность

### Backend (Express + TypeScript)

1. **Роут авторизации** (`/auth/login`)
   - Принимает `username` и `password`
   - Проверяет пароль с использованием bcrypt
   - Возвращает JWT токен и информацию о пользователе

2. **Роут регистрации** (`/auth/signup`)
   - Создает нового пользователя с хешированием пароля
   - Проверяет уникальность username и email
   - Автоматически авторизует пользователя после регистрации

3. **Роут проверки токена** (`/auth/me`)
   - Проверяет JWT токен и возвращает информацию о текущем пользователе

### Frontend (Angular)

1. **AuthService** - сервис для работы с авторизацией
   - `login()` - авторизация пользователя
   - `signup()` - регистрация пользователя
   - `logout()` - выход из системы
   - `isAuthenticated()` - проверка авторизации
   - `isAdmin()` - проверка роли администратора

2. **Access Guard** - защита роутов
   - Проверяет наличие JWT токена в localStorage
   - Перенаправляет на `/login` если токен отсутствует

3. **Компоненты форм**
   - `LoginCard` - форма входа
   - `SignupCard` - форма регистрации
   - Отображение ошибок от сервера

4. **Кнопка администрирования**
   - Отображается только для пользователей с ролью `admin`
   - Ведет на внешний адрес `https://localhost:3000/`

## Как использовать

### 1. Запуск сервера

```bash
cd admin
npm run start:server
```

### 2. Запуск клиента

```bash
cd client
npm start
```

### 3. Тестирование

#### Вход существующего пользователя

Для входа с существующим пользователем:
- Перейдите на `/login`
- Введите `username: Korzik` (или любой другой username из users.json)
- Введите пароль (по умолчанию: `password`)

**Примечание:** Если пароли в users.json не захешированы, запустите скрипт обновления:
```bash
cd admin
npx tsx src/server/scripts/update-passwords.ts
```

#### Регистрация нового пользователя

- Перейдите на `/signup`
- Заполните все обязательные поля:
  - Имя пользователя (минимум 3 символа)
  - Email
  - Имя, Фамилия
  - Отчество (необязательно)
  - Пароль (минимум 6 символов)
  - Подтверждение пароля
  - Дата рождения

#### Для администраторов

Пользователи с полем `"role": "admin"` в базе данных увидят дополнительную кнопку "Администрирование" в боковом меню, которая ведет на `https://localhost:3000/`.

## Структура токена JWT

Токен содержит следующие данные:
```json
{
  "userId": 1,
  "username": "Korzik",
  "role": "admin"
}
```

Токен действителен 24 часа.

## Хранение данных

- **Токен**: хранится в `localStorage` под ключом `token`
- **Информация о пользователе**: хранится в `localStorage` под ключом `user`

## Безопасность

1. Пароли хешируются с использованием bcrypt (10 раундов)
2. JWT токены подписываются секретным ключом
3. Защищенные роуты проверяются через Angular Guard
4. CORS включен для взаимодействия клиента и сервера

## Дополнительно

### Выход из системы

Можно добавить кнопку выхода в Layout:
```typescript
logout() {
    this.authService.logout();
}
```

### Проверка токена на сервере

Для защиты серверных роутов можно создать middleware:
```typescript
import jwt from 'jsonwebtoken';

export const authMiddleware = (req, res, next) => {
    const token = req.headers.authorization?.split(' ')[1];
    if (!token) return res.status(401).json({ message: 'Unauthorized' });
    
    try {
        const decoded = jwt.verify(token, JWT_SECRET);
        req.user = decoded;
        next();
    } catch (error) {
        res.status(401).json({ message: 'Invalid token' });
    }
};
```

## Известные пользователи для тестирования

Из `users.json`:
- **username**: `Korzik`, **role**: `admin` (увидит кнопку администрирования)
- **password**: `password` (после запуска скрипта update-passwords.ts)

## Troubleshooting

### Ошибка "Cannot find module"
Убедитесь, что установлены все зависимости:
```bash
cd admin
npm install
```

### Ошибка CORS
Убедитесь, что в `server.ts` включен CORS:
```typescript
app.use(cors());
```

### Не работает авторизация
1. Проверьте, что сервер запущен на `https://localhost:3000`
2. Проверьте, что пароли захешированы (запустите update-passwords.ts)
3. Проверьте консоль браузера на наличие ошибок
