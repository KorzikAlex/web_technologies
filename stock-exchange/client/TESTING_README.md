# E2E тесты для клиентского приложения

## Требование задания #7

> Разработаны автоматизированные тесты для проверки корректности работы клиентской части web-приложения с использованием headless-браузера или фреймворка Selenium. Как минимум необходимо проверить, что при покупке/продаже N акций в определённую дату соответствующим образом изменяется баланс средств брокера и через некоторое время получается правильная прибыль/убыток по данной акции.

## Реализовано

✅ **Фреймворк:** Playwright (headless Chromium)  
✅ **Файл тестов:** `e2e/trading.spec.ts`  
✅ **Количество тестов:** 4

### Тесты

1. **Покупка акций - изменение баланса брокера**
   - Получает начальный баланс
   - Покупает 10 акций AAPL
   - Проверяет уменьшение баланса
   - Выводит потраченную сумму и цену за акцию

2. **Продажа акций - изменение баланса брокера**
   - Получает начальный баланс
   - Продает 5 акций из портфеля
   - Проверяет увеличение баланса
   - Выводит полученную сумму и цену за акцию

3. **Прибыль/убыток по акции в портфеле**
   - Открывает портфель брокера
   - Проверяет отображение данных:
     - Количество акций
     - Средняя цена покупки
     - Текущая цена
     - **Прибыль/Убыток** (рассчитывается автоматически)
   - Выводит все данные в консоль

4. **Полный цикл: покупка → ожидание → продажа**
   - Фиксирует начальный баланс
   - Покупает 15 акций AMD
   - Ожидает 3 секунды (симуляция изменения цены)
   - Проверяет текущую прибыль/убыток
   - Продает все 15 акций
   - Рассчитывает итоговый результат (прибыль/убыток)

## Запуск тестов

### Подготовка

**ВАЖНО:** Перед запуском тестов нужно запустить торги через админку!

1. Запустить бэкенд:
```bash
cd server
npm run start:dev
```

2. Запустить админку:
```bash
cd admin
npm run dev
```

3. **Запустить торги:**
   - Открыть http://localhost:5174 (админка)
   - Перейти на страницу "Биржа"
   - Нажать кнопку "Запустить торги"
   - Дождаться, пока статус изменится на "Торги запущены"

4. Запустить клиент:
```bash
cd client
npm run dev
```

### Команды запуска

```bash
cd client

# Обычный запуск (headless)
npm test

# С видимым браузером
npm run test:headed

# Интерактивный UI-режим
npm run test:ui

# Режим отладки
npm run test:debug

# Показать отчет
npm run test:report
```

## Пример вывода

```
=== ПОКУПКА АКЦИЙ ===
Начальный баланс: 73667.80 ₽
Акция: AAPL
Текущая цена: 43,54 ₽
Баланс после покупки: 73232.40 ₽
Потрачено на покупку 10 акций: 435.40 ₽
Цена за 1 акцию: 43.54 ₽

=== ПРОДАЖА АКЦИЙ ===
Начальный баланс: 73232.40 ₽
Акция в портфеле: META
Количество: 100 шт.
Текущая цена: 87,23 ₽
Баланс после продажи: 73668.55 ₽
Получено за продажу 5 акций: 436.15 ₽
Цена за 1 акцию: 87.23 ₽

=== ПРИБЫЛЬ/УБЫТОК ===
Акция: META
Количество: 95 шт.
Средняя цена покупки: 85,50 ₽
Текущая цена: 87,23 ₽
Прибыль/Убыток: +164.35 ₽

✓ Прибыль/убыток рассчитан: 164.35 ₽

=== ПОЛНЫЙ ЦИКЛ ТОРГОВЛИ ===
1. Начальный баланс: 73668.55 ₽
2. Покупаем 15 акций AMD по цене: 124,67 ₽
   Баланс после покупки: 71798.50 ₽
   Потрачено: 1870.05 ₽
3. Ожидаем изменения цены акций...
4. Текущая прибыль/убыток по AMD: -45.30 ₽
5. Продаем 15 акций AMD
   Финальный баланс: 73643.25 ₽

✓ ИТОГОВЫЙ РЕЗУЛЬТАТ: -25.30 ₽
   Убыток зафиксирован.
```

## Структура файлов

```
client/
├── e2e/
│   ├── trading.spec.ts        ← Основные тесты для задания
│   └── helpers/
│       └── broker-helpers.ts  ← Вспомогательные функции
├── playwright.config.ts       ← Конфигурация Playwright
├── package.json              ← Скрипты запуска
└── TESTING_README.md         ← Эта документация
```

## Технические детали

- **Браузер:** Chromium (headless)
- **Timeout:** 60 секунд
- **Брокер для тестов:** "Гоблин" (из `server/data/brokers.json`)
- **Стратегия ожидания:** networkidle
- **Отчеты:** HTML + Console
- **Скриншоты:** При ошибках
- **Видео:** При ошибках

## Соответствие заданию

| Требование | Реализация |
|-----------|-----------|
| Headless-браузер | ✅ Playwright + Chromium |
| Покупка N акций | ✅ Тест "Покупка акций" (N=10) |
| Изменение баланса при покупке | ✅ Проверяется уменьшение |
| Продажа N акций | ✅ Тест "Продажа акций" (N=5) |
| Изменение баланса при продаже | ✅ Проверяется увеличение |
| Прибыль/убыток по акции | ✅ Тест "Прибыль/убыток" |
| Через некоторое время | ✅ Тест "Полный цикл" с ожиданием 3с |

Все требования задания **выполнены**.
